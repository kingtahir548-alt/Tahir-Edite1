<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahir Tahir - AI Preset Library v19.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --primary: #3b82f6; --accent: #8b5cf6; --bg: #050505; --glass: rgba(15, 15, 15, 0.85); }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #f1f5f9; margin: 0; overflow: hidden; }
        .glass { background: var(--glass); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-zaxm { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .mode-btn { padding: 10px 20px; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); color: #64748b; }
        .mode-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4); }

        .preset-card { transition: all 0.3s; border: 2px solid transparent; cursor: pointer; }
        .preset-card:hover { transform: translateY(-4px); border-color: rgba(59, 130, 246, 0.4); }
        .preset-card.active { border-color: var(--primary); box-shadow: 0 0 25px rgba(59, 130, 246, 0.3); }

        input[type=range] { -webkit-appearance: none; background: rgba(255, 255, 255, 0.1); height: 4px; border-radius: 10px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: white; cursor: pointer; border: 2px solid var(--primary); }
        
        .canvas-container { overflow: auto; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background: #000; position: relative; padding: 20px; }
        #main-canvas { box-shadow: 0 40px 150px rgba(0,0,0,1); border-radius: 6px; max-width: 100%; max-height: 100%; object-fit: contain; }

        .batch-item { flex-shrink: 0; width: 65px; height: 65px; border-radius: 14px; overflow: hidden; border: 2px solid transparent; cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .batch-item.active { border-color: var(--primary); opacity: 1; transform: scale(1.1); }

        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }

        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .accordion-item.active .accordion-content { max-height: 1200px; padding-bottom: 1.5rem; }
        .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .drag-active { border-color: var(--primary) !important; background: rgba(59, 130, 246, 0.1) !important; }

        @media (max-width: 1024px) {
            .sidebar { position: absolute !important; bottom: 0; left: 0; width: 100% !important; height: 50vh !important; z-index: 100; border-radius: 3rem 3rem 0 0 !important; background: rgba(10, 10, 10, 0.95) !important; }
            .viewport { height: 100vh !important; width: 100vw !important; }
            .batch-strip { position: absolute; top: 110px; left: 15px; z-index: 90; width: 75px !important; }
            header { position: absolute; top: 0; width: 100%; z-index: 110; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p id="loading-text" class="text-xs font-black uppercase tracking-widest text-slate-400">خەریکی گواستنەوەی ڕەنگە...</p>
    </div>

    <div class="max-w-[2000px] mx-auto h-screen flex flex-col overflow-hidden relative">
        <!-- Header -->
        <header class="flex items-center justify-between p-5 flex-shrink-0">
            <div class="flex items-center gap-5">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-2xl font-black text-xl text-white">T</div>
                <div class="hidden sm:block">
                    <h1 class="text-2xl font-black tracking-tighter uppercase italic leading-none text-white">Tahir <span class="text-blue-500">Tahir</span></h1>
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.3em] mt-1">Preset Manager v19.6</p>
                </div>
            </div>

            <!-- Mode Switcher -->
            <div class="flex glass p-1.5 rounded-2xl gap-2">
                <button onclick="switchMode('creator')" id="btn-mode-creator" class="mode-btn active">Create Preset</button>
                <button onclick="switchMode('editor')" id="btn-mode-editor" class="mode-btn">Use Library</button>
            </div>

            <div class="flex items-center gap-3">
                <div id="toast" class="hidden glass px-6 py-2 rounded-full text-[11px] font-black text-blue-400 border border-blue-500/20 shadow-2xl animate-pulse">Save Successful! ✓</div>
                <button onclick="location.reload()" class="w-11 h-11 glass rounded-full flex items-center justify-center hover:bg-red-500/20 transition-all text-white">✕</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex overflow-hidden">
            
            <!-- LEFT: Preset Gallery -->
            <div class="w-[300px] glass border-r border-white/5 flex flex-col p-6 hidden lg:flex">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-500 mb-6 flex items-center gap-2 italic">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 3v18M15 3v18M3 9h18M3 15h18"/></svg>
                    PRESET LIBRARY
                </h3>
                <div id="preset-list" class="flex-1 space-y-4 overflow-y-auto custom-scrollbar pr-2">
                    <div class="text-center py-20 opacity-20"><p class="text-[10px] font-bold">باردەبێت...</p></div>
                </div>
            </div>

            <!-- RIGHT: Dynamic Work Area -->
            <div class="flex-1 flex flex-col overflow-hidden relative">
                
                <!-- CREATOR VIEW -->
                <div id="view-creator" class="flex-1 flex flex-col items-center justify-center p-10 animate-in fade-in duration-500">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 w-full max-w-5xl">
                        <label id="src-drop" class="glass rounded-[3.5rem] aspect-square flex flex-col items-center justify-center cursor-pointer border-dashed border-2 border-white/10 hover:border-blue-500/40 transition-all overflow-hidden group shadow-2xl relative">
                            <img id="creator-src-img" class="hidden w-full h-full object-cover">
                            <div id="creator-src-hold" class="text-center opacity-40 group-hover:opacity-100">
                                <svg class="mx-auto mb-5" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                <p class="text-[13px] font-black uppercase tracking-[0.2em]">وێنەی پرێسێت بار بکە</p>
                                <p class="text-[9px] mt-2 text-blue-400 italic">وێنەکە ڕابکێشە بۆ ئێرە</p>
                            </div>
                            <input type="file" id="creator-src-in" class="hidden" accept="image/*">
                        </label>
                        <div class="flex flex-col justify-center gap-6">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest px-2 italic">ناوی پرێسێت</label>
                                <input type="text" id="preset-name" placeholder="بۆ نموونە: Dark Cinema" class="w-full bg-white/5 border border-white/10 p-5 rounded-3xl text-white font-bold outline-none focus:border-blue-500 transition-all">
                            </div>
                            <button id="save-preset-btn" disabled class="w-full py-7 btn-zaxm text-white rounded-[2.5rem] font-black text-xl shadow-2xl opacity-20 cursor-not-allowed transition-all">سەیڤکردن بۆ کتێبخانە</button>
                            <p class="text-[10px] text-slate-500 text-center italic">تێبینی: سیستەمی Neural شێوازی ڕووناکی و ڕەنگی ئەم وێنەیە بۆت دەپارێزێت.</p>
                        </div>
                    </div>
                </div>

                <!-- EDITOR VIEW -->
                <div id="view-editor" class="hidden flex-1 flex flex-col lg:flex-row overflow-hidden relative">
                    <div id="filmstrip" class="batch-strip flex lg:flex-col gap-5 overflow-x-auto lg:overflow-y-auto p-5 lg:w-32 flex-shrink-0 bg-black/40 shadow-2xl"></div>
                    
                    <div class="viewport flex-1 relative overflow-hidden bg-[#020202]">
                        <div class="canvas-container" id="container">
                            <canvas id="main-canvas"></canvas>
                        </div>
                        <!-- UI Overlays -->
                        <div class="absolute bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 glass px-12 py-5 rounded-full border border-white/10 shadow-[0_20px_80px_rgba(0,0,0,1)] z-20">
                            <button onclick="zoomAdjust(0.7)" class="p-2 hover:text-blue-500"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                            <button onclick="fitView()" class="text-[12px] font-black uppercase text-blue-400">Fit View</button>
                            <span id="zoom-val" class="text-[13px] font-black w-16 text-center text-slate-100">100%</span>
                            <button onclick="zoomAdjust(1.4)" class="p-2 hover:text-blue-500"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                        </div>
                        <div class="absolute top-24 lg:top-8 left-8 flex gap-4 z-30">
                            <button onclick="copySets()" class="glass px-6 py-3 rounded-full text-[11px] font-black uppercase text-blue-400">Copy</button>
                            <button onclick="pasteSets()" class="glass px-6 py-3 rounded-full text-[11px] font-black uppercase text-purple-400">Paste</button>
                            <button id="comp-btn" class="glass px-8 py-3 text-[11px] font-black uppercase text-white rounded-full active:bg-blue-600">Compare</button>
                        </div>
                    </div>

                    <div class="sidebar lg:w-[420px] glass p-8 flex flex-col gap-8 shadow-2xl z-50 overflow-y-auto custom-scrollbar h-full">
                        <div class="p-8 bg-blue-600/15 rounded-[2.5rem] border border-blue-500/30 shadow-inner">
                            <div class="flex justify-between text-[12px] font-black text-blue-400 uppercase mb-4 italic"><span>هێزی پرێسێت (Match)</span><span id="intensity-v">100%</span></div>
                            <input type="range" id="intensity" min="0" max="100" value="100" class="accent-blue-500">
                        </div>

                        <div class="space-y-3 flex-1">
                            <div class="accordion-item active">
                                <div class="accordion-header" onclick="toggleAcc(this)"><span class="text-[11px] font-black uppercase tracking-widest text-slate-200 italic">ڕێکخستنی دەستی</span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg></div>
                                <div class="accordion-content space-y-7 pt-6 px-1">
                                    <div class="space-y-2"><div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase"><span>Exposure</span><span id="exposure-v">100</span></div><input type="range" id="exposure" min="40" max="180" value="100"></div>
                                    <div class="space-y-2"><div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase"><span>Contrast</span><span id="contrast-v">100</span></div><input type="range" id="contrast" min="40" max="180" value="100"></div>
                                    <div class="space-y-2"><div class="flex justify-between text-[11px] font-black text-pink-400 uppercase tracking-widest"><span>Skin Smoothing</span><span id="smoothing-v">0%</span></div><input type="range" id="smoothing" min="0" max="100" value="0" class="accent-pink-500"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4 pt-8 border-t border-white/5">
                            <button onclick="dlAllZIP()" class="w-full py-5 bg-blue-600/10 text-blue-400 rounded-2xl font-black text-xs uppercase tracking-widest border border-blue-500/20">داگرتنی گشت وێنەکان (ZIP)</button>
                            <button onclick="dlActive()" class="w-full py-7 btn-zaxm text-white rounded-[2.5rem] font-black text-lg shadow-2xl italic tracking-tighter">دابەزاندنی ئەم وێنەیە</button>
                        </div>
                    </div>
                </div>

                <!-- EMPTY STATE (EDITOR DROP ZONE) -->
                <div id="view-empty" class="hidden flex-1 flex flex-col items-center justify-center p-20 bg-[#080808] border-2 border-dashed border-transparent transition-all">
                    <div class="text-center space-y-6 max-w-md pointer-events-none">
                        <div class="w-24 h-24 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-8 border border-white/10"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m2-5 5 5 5-5m-5 5V3" /></svg></div>
                        <h2 class="text-3xl font-black uppercase italic tracking-tighter text-white">وێنەکانت بار بکە</h2>
                        <p class="text-slate-500 text-sm font-bold">وێنەکانت ڕابکێشە بۆ ئێرە یان کلیک لەسەر دوگمەی خوارەوە بکە.</p>
                        <button onclick="document.getElementById('tar-in-hidden').click()" class="px-12 py-6 bg-white text-black rounded-full font-black uppercase text-xs tracking-widest hover:scale-105 active:scale-95 transition-all pointer-events-auto">Select Photos</button>
                        <input type="file" id="tar-in-hidden" class="hidden" accept="image/*" multiple>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Initialization
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tahir-preset-app';

        // State
        let presets = []; let batch = []; let activeIdx = 0; let selectedPreset = null;
        let zoomL = 1.0, fitS = 1.0; let pBaseC = document.createElement('canvas');
        let isRendering = false, isComparing = false;
        const SLIDERS = ['intensity', 'exposure', 'contrast', 'smoothing'];

        const get = id => document.getElementById(id);

        // --- AUTH & DATA SYNC ---
        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            onAuthStateChanged(auth, user => {
                if (!user) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'presets');
                onSnapshot(q, snap => {
                    presets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderPresetList();
                });
            });
        };
        init();

        // --- DRAG AND DROP HANDLER ---
        const setupDD = (dropZone, input) => {
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.add('drag-active');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    dropZone.classList.remove('drag-active');
                }, false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    input.files = files;
                    input.dispatchEvent(new Event('change'));
                }
            }, false);
        };

        // Wire up Drag and Drop
        setupDD(get('src-drop'), get('creator-src-in'));
        setupDD(get('view-empty'), get('tar-in-hidden'));

        // --- PRESET CREATION ---
        let tempSrcStats = null;
        get('creator-src-in').onchange = e => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    get('creator-src-img').src = ev.target.result;
                    get('creator-src-img').classList.remove('hidden'); get('creator-src-hold').classList.add('hidden');
                    const tx = document.createElement('canvas').getContext('2d'); tx.canvas.width=256; tx.canvas.height=256;
                    tx.drawImage(img,0,0,256,256);
                    tempSrcStats = getStats(tx, 256, 256);
                    get('save-preset-btn').disabled = false;
                    get('save-preset-btn').classList.remove('opacity-20','cursor-not-allowed');
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(f);
        };

        window.saveAppPreset = async () => {
            const name = get('preset-name').value.trim() || "New Preset";
            if(!tempSrcStats) return;
            get('loading-overlay').style.display = 'flex';
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'presets'), {
                    name, stats: JSON.stringify(tempSrcStats), thumb: get('creator-src-img').src, createdAt: Date.now()
                });
                get('preset-name').value = ''; 
                get('creator-src-img').classList.add('hidden'); get('creator-src-hold').classList.remove('hidden');
                get('toast').classList.remove('hidden'); setTimeout(()=>get('toast').classList.add('hidden'),2000);
            } catch(e) { console.error(e); }
            get('loading-overlay').style.display = 'none';
        };
        get('save-preset-btn').onclick = window.saveAppPreset;

        // --- EDITOR ENGINE ---
        get('tar-in-hidden').onchange = e => {
            const fs = Array.from(e.target.files).slice(0, 30); if(!fs.length) return;
            batch = []; let loaded = 0;
            fs.forEach(f => {
                const r = new FileReader();
                r.onload = ev => {
                    const img = new Image();
                    img.onload = () => {
                        batch.push({ img, data: ev.target.result, settings: {intensity:100, exposure:100, contrast:100, smoothing:0} });
                        loaded++;
                        if(loaded === fs.length) {
                            get('view-empty').classList.add('hidden'); get('view-editor').classList.remove('hidden');
                            loadPhoto(0);
                        }
                    };
                    img.src = ev.target.result;
                };
                r.readAsDataURL(f);
            });
        };

        const loadPhoto = idx => {
            if(batch[activeIdx]) batch[activeIdx].settings = getUI();
            activeIdx = idx; renderFilmstrip();
            const item = batch[idx];
            fitS = Math.min((get('container').clientWidth-40) / item.img.width, (get('container').clientHeight-40) / item.img.height);
            zoomL = 1.0; 
            if(selectedPreset) applyPresetLogic(item, selectedPreset);
            else {
                const ctx = pBaseC.getContext('2d'); pBaseC.width=item.img.width; pBaseC.height=item.img.height;
                ctx.drawImage(item.img,0,0);
                setUI(item.settings); updateZoom(); render();
            }
        };

        const applyPresetLogic = (item, preset) => {
            const srcStats = JSON.parse(preset.stats);
            const ctx = pBaseC.getContext('2d'); pBaseC.width=item.img.width; pBaseC.height=item.img.height;
            ctx.drawImage(item.img, 0, 0);
            const idata = ctx.getImageData(0,0,item.img.width,item.img.height);
            const d = idata.data;
            const tX = document.createElement('canvas').getContext('2d'); tX.canvas.width=256; tX.canvas.height=256;
            tX.drawImage(item.img,0,0,256,256);
            const tStats = getStats(tX, 256, 256);

            const buildCDF = h => { let cdf=new Array(256).fill(0), sum=0, tot=h.reduce((a,b)=>a+b,0); for(let i=0;i<256;i++){ sum+=h[i]; cdf[i]=sum/tot; } return cdf; };
            const sCDF = buildCDF(srcStats.histogram), tCDF = buildCDF(tStats.histogram);
            let LUT = new Array(256);
            for(let i=0; i<256; i++){ let j=0; while(j<255 && sCDF[j]<tCDF[i]) j++; LUT[i]=j; }
            const sR = srcStats.std.r/tStats.std.r, sG = srcStats.std.g/tStats.std.g, sB = srcStats.std.b/tStats.std.b;

            for(let j=0; j<d.length; j+=4) {
                const lum = Math.round(0.299*d[j] + 0.587*d[j+1] + 0.114*d[j+2]);
                const ratio = LUT[lum] / (lum || 1);
                d[j] = Math.max(0,Math.min(255, ((d[j]-tStats.mean.r)*sR + srcStats.mean.r)*0.85 + (d[j]*ratio)*0.15));
                d[j+1] = Math.max(0,Math.min(255, ((d[j+1]-tStats.mean.g)*sG + srcStats.mean.g)*0.85 + (d[j+1]*ratio)*0.15));
                d[j+2] = Math.max(0,Math.min(255, ((d[j+2]-tStats.mean.b)*sB + srcStats.mean.b)*0.85 + (d[j+2]*ratio)*0.15));
            }
            ctx.putImageData(idata, 0, 0);
            setUI(item.settings); updateZoom(); render();
        };

        const render = (targetCanvas = get('main-canvas'), settings = getUI(), sourceImg = batch[activeIdx]?.img, matchedImg = pBaseC) => {
            if(!sourceImg) return;
            const ctx = targetCanvas.getContext('2d');
            const w = sourceImg.width, h = sourceImg.height;
            targetCanvas.width = w; targetCanvas.height = h;

            if(isComparing && targetCanvas === get('main-canvas')) { ctx.drawImage(sourceImg, 0, 0); return; }

            const blend = settings.intensity / 100;
            const buf = document.createElement('canvas'); buf.width=w; buf.height=h; const bX = buf.getContext('2d');
            bX.drawImage(sourceImg, 0, 0); bX.globalAlpha = blend; bX.drawImage(matchedImg, 0, 0); bX.globalAlpha = 1.0;

            if(settings.smoothing > 0) {
                const idata = bX.getImageData(0,0,w,h); const d = idata.data; const copy = new Uint8ClampedArray(d);
                const step = w > 1600 ? 3 : 1; const rad = Math.max(1, Math.floor(settings.smoothing/15)); const smFactor = settings.smoothing/220;
                for(let y=0; y<h; y+=step) {
                    for(let x=0; x<w; x+=step) {
                        const i = (y*w+x)*4;
                        if(d[i]>75 && d[i+1]>50 && d[i]>d[i+1]) {
                            if(y>rad && y<h-rad && x>rad && x<w-rad) {
                                let sr=0,sg=0,sb=0,sc=0;
                                for(let ky=-rad; ky<=rad; ky+=rad) for(let kx=-rad; kx<=rad; kx+=rad) { const ki=((y+ky)*w+(x+kx))*4; sr+=copy[ki]; sg+=copy[ki+1]; sb+=copy[ki+2]; sc++; }
                                d[i]=copy[i]*(1-smFactor)+(sr/sc)*smFactor; d[i+1]=copy[i+1]*(1-smFactor)+(sg/sc)*smFactor; d[i+2]=copy[i+2]*(1-smFactor)+(sb/sc)*smFactor;
                            }
                        }
                    }
                }
                bX.putImageData(idata,0,0);
            }

            ctx.filter = `brightness(${settings.exposure}%) contrast(${settings.contrast}%)`;
            ctx.drawImage(buf, 0, 0);
        };

        // --- UI HELPERS ---
        window.switchMode = mode => {
            get('btn-mode-creator').classList.toggle('active', mode==='creator');
            get('btn-mode-editor').classList.toggle('active', mode==='editor');
            get('view-creator').style.display = mode==='creator' ? 'flex' : 'none';
            if(mode==='editor') {
                if(batch.length > 0) { get('view-editor').classList.remove('hidden'); get('view-empty').classList.add('hidden'); }
                else { get('view-editor').classList.add('hidden'); get('view-empty').classList.remove('hidden'); }
            } else { get('view-editor').classList.add('hidden'); get('view-empty').classList.add('hidden'); }
        };

        const renderPresetList = () => {
            const list = get('preset-list');
            list.innerHTML = presets.map(p => `
                <div class="preset-card glass rounded-2xl p-2 relative ${selectedPreset?.id === p.id ? 'active' : ''}" onclick="selectPreset('${p.id}')">
                    <img src="${p.thumb}" class="w-full aspect-video object-cover rounded-xl mb-3">
                    <div class="px-2 pb-1 flex justify-between items-center">
                        <span class="text-[10px] font-black uppercase truncate">${p.name}</span>
                        <button onclick="event.stopPropagation(); deletePreset('${p.id}')" class="text-red-500 opacity-40 hover:opacity-100 transition-all"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                    </div>
                </div>
            `).join('') || '<div class="text-center py-20 opacity-20"><p class="text-[10px] font-bold">کتێبخانەکە چۆڵە</p></div>';
        };

        window.selectPreset = id => { selectedPreset = presets.find(p => p.id === id); renderPresetList(); if(batch[activeIdx]) loadPhoto(activeIdx); };
        window.deletePreset = async id => { if(confirm("دڵنیای؟")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presets', id)); };
        const renderFilmstrip = () => { get('filmstrip').innerHTML = batch.map((it, i) => `<div class="batch-item ${i===activeIdx?'active':''}" onclick="loadPhoto(${i})"><img src="${it.data}" class="w-full h-full object-cover"></div>`).join(''); };
        const getStats = (ctx, w, h) => {
            const d = ctx.getImageData(0,0,w,h).data; let r=0,g=0,b=0,c=d.length/4,hist=new Array(256).fill(0);
            for(let i=0;i<d.length;i+=4){ const l=Math.round(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]); hist[l]++; r+=d[i]; g+=d[i+1]; b+=d[i+2]; }
            const m={r:r/c,g:g/c,b:b/c}; let vr=0,vg=0,vb=0; for(let i=0;i<d.length;i+=4){ vr+=Math.pow(d[i]-m.r,2); vg+=Math.pow(d[i+1]-m.g,2); vb+=Math.pow(d[i+2]-m.b,2); }
            return {mean:m, std:{r:Math.sqrt(vr/c)||1, g:Math.sqrt(vg/c)||1, b:Math.sqrt(vb/c)||1}, histogram: hist};
        };

        const getUI = () => { const o={}; SLIDERS.forEach(s=>o[s]=parseInt(get(s).value)); return o; };
        const setUI = o => { SLIDERS.forEach(s=>{ get(s).value=o[s]; const v=get(s+'-v'); if(v) v.innerText=(s==='smoothing'||s==='intensity')?o[s]+'%':o[s]; }); };
        SLIDERS.forEach(s => get(s).oninput = () => { const v=get(s+'-v'); if(v) v.innerText=(s==='smoothing'||s==='intensity')?get(s).value+'%':get(s).value; render(); });

        window.toggleAcc = el => el.parentElement.classList.toggle('active');
        window.zoomAdjust = m => { zoomL*=m; if(zoomL<0.05) zoomL=0.05; updateZoom(); };
        window.fitView = () => { zoomL=1.0; updateZoom(); get('container').scrollLeft=0; get('container').scrollTop=0; };
        window.updateZoom = () => { const it=batch[activeIdx]; if(!it) return; const s=fitS*zoomL; get('main-canvas').style.width=(it.img.width*s)+'px'; get('main-canvas').style.height=(it.img.height*s)+'px'; get('zoom-val').innerText=Math.round(zoomL*100)+'%'; };
        window.dlActive = () => { const a=document.createElement('a'); a.download=`Tahir_Edit.jpg`; a.href=get('main-canvas').toDataURL('image/jpeg',1.0); a.click(); };

        window.dlAllZIP = async () => {
            if(!batch.length || !selectedPreset) return;
            const zip = new JSZip(); get('loading-overlay').style.display='flex'; get('loading-text').innerText="ئامادە دەکرێت...";
            const tempC = document.createElement('canvas');
            for(let i=0; i<batch.length; i++){
                get('loading-text').innerText = `${i+1} / ${batch.length} Processing...`;
                loadPhoto(i); await new Promise(r=>setTimeout(r,100));
                render(tempC, batch[i].settings, batch[i].img, pBaseC);
                const blob = await new Promise(r => tempC.toBlob(r, 'image/jpeg', 1.0));
                zip.file(`Tahir_Batch_${i+1}.jpg`, blob);
            }
            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = "Tahir_Batch.zip"; a.click();
            get('loading-overlay').style.display = 'none';
        };

        // Panning
        let isD=false, sx, sy, sl, st;
        get('container').onmousedown = e => { if(zoomL<=1) return; isD=true; sx=e.pageX-get('container').offsetLeft; sy=e.pageY-get('container').offsetTop; sl=get('container').scrollLeft; st=get('container').scrollTop; };
        window.addEventListener('mouseup',()=>isD=false);
        get('container').onmousemove = e => { if(!isD) return; get('container').scrollLeft=sl-(e.pageX-get('container').offsetLeft-sx); get('container').scrollTop=st-(e.pageY-get('container').offsetTop-sy); };
        get('comp-btn').onmousedown = () => { isComparing=true; render(); };
        get('comp-btn').onmouseup = () => { isComparing=false; render(); };
    </script>
</body>
</html>
