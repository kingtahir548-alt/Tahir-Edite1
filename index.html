<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahir Tahir - AI Vision Ultra v12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        :root { --primary: #3b82f6; --accent: #8b5cf6; --bg: #050505; --glass: rgba(12, 12, 12, 0.85); }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #f1f5f9; margin: 0; overflow: hidden; }
        .glass { background: var(--glass); backdrop-filter: blur(40px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-zaxm { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        input[type=range] { -webkit-appearance: none; background: rgba(255, 255, 255, 0.1); height: 5px; border-radius: 10px; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: white; cursor: pointer; border: 2px solid var(--primary); box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .accordion-item.active .accordion-content { max-height: 1200px; padding-bottom: 1.5rem; }
        .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 15px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .accordion-header:hover { background: rgba(255,255,255,0.03); }
        
        .canvas-container { 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 100%; 
            height: 100%; 
            background: #000; 
            position: relative; 
            padding: 40px;
        }
        
        #main-canvas { 
            box-shadow: 0 40px 120px rgba(0,0,0,1);
            border-radius: 4px;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            image-rendering: auto;
        }

        .batch-item { flex-shrink: 0; width: 70px; height: 70px; border-radius: 16px; overflow: hidden; border: 2.5px solid transparent; cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .batch-item.active { border-color: var(--primary); opacity: 1; transform: scale(1.1); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4); }

        .hsl-btn { width: 28px; height: 28px; border-radius: 50%; border: 2.5px solid transparent; transition: 0.2s; }
        .hsl-btn.active { transform: scale(1.3); border-color: white; box-shadow: 0 0 20px rgba(255,255,255,0.4); }

        @media (max-width: 1024px) {
            .sidebar { 
                position: absolute !important; bottom: 0; left: 0; width: 100% !important; height: 48vh !important; 
                z-index: 100; border-radius: 2.5rem 2.5rem 0 0 !important;
            }
            .viewport { height: 100vh !important; width: 100vw !important; }
            .batch-strip { position: absolute; top: 100px; left: 15px; z-index: 90; width: 75px !important; }
            header { position: absolute; top: 0; width: 100%; z-index: 110; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); }
            .canvas-container { padding: 10px; }
        }
    </style>
</head>
<body>

    <div class="max-w-[2000px] mx-auto h-screen flex flex-col overflow-hidden relative">
        <!-- Header -->
        <header class="flex items-center justify-between p-5 flex-shrink-0">
            <div class="flex items-center gap-4 text-white">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-2xl font-black text-xl">T</div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter uppercase italic leading-none">Tahir <span class="text-blue-500">Tahir</span></h1>
                    <p class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.4em] mt-1 italic">Ultra Neural Engine v12.0</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="toast" class="hidden glass px-6 py-2 rounded-full text-[11px] font-black text-blue-400 border border-blue-500/20 shadow-2xl animate-pulse">Copied! ✓</div>
                <button onclick="location.reload()" class="w-11 h-11 glass rounded-full flex items-center justify-center hover:bg-red-500/20 transition-all text-white">✕</button>
            </div>
        </header>

        <!-- Step 1: Upload UI -->
        <div id="upload-section" class="flex-1 flex flex-col justify-center items-center gap-12 animate-in fade-in duration-700 bg-[#080808] z-50">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 w-full max-w-6xl px-10">
                <label id="src-drop" class="glass rounded-[3.5rem] aspect-video flex flex-col items-center justify-center cursor-pointer border-dashed border-2 border-white/10 hover:border-blue-500/40 transition-all group overflow-hidden shadow-2xl">
                    <img id="src-pre" class="hidden w-full h-full object-cover">
                    <div id="src-hold" class="text-center opacity-40 group-hover:opacity-100 transition-all">
                        <svg class="mx-auto mb-5" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        <p class="text-[13px] font-black uppercase tracking-[0.2em]">١. شێوازی پرێسێت (Style Source)</p>
                    </div>
                    <input type="file" id="src-in" class="hidden" accept="image/*">
                </label>
                <label id="tar-drop" class="glass rounded-[3.5rem] aspect-video flex flex-col items-center justify-center cursor-pointer border-dashed border-2 border-white/10 hover:border-purple-500/40 transition-all group overflow-hidden shadow-2xl">
                    <div id="tar-hold" class="text-center opacity-40 group-hover:opacity-100 transition-all">
                        <svg class="mx-auto mb-5" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m2-5 5 5 5-5m-5 5V3" /></svg>
                        <p class="text-[13px] font-black uppercase tracking-[0.2em]">٢. وێنەکانت (Batch Upload)</p>
                    </div>
                    <div id="tar-grid" class="hidden grid grid-cols-4 gap-4 p-10 w-full h-full overflow-y-auto custom-scrollbar"></div>
                    <input type="file" id="tar-in" class="hidden" accept="image/*" multiple>
                </label>
            </div>
            <button id="proc-btn" disabled class="px-32 py-8 bg-slate-900 text-slate-700 rounded-full font-black text-3xl shadow-2xl transition-all uppercase italic border border-white/5 tracking-tighter">بە زیرەکی ڕێندەری بکە</button>
        </div>

        <!-- Step 2: Editor UI -->
        <div id="editor-section" class="hidden flex flex-col lg:flex-row flex-1 overflow-hidden relative">
            <div id="filmstrip" class="batch-strip flex lg:flex-col gap-5 overflow-x-auto lg:overflow-y-auto p-5 lg:w-32 flex-shrink-0 bg-black/40 shadow-2xl"></div>

            <div class="viewport flex-1 relative overflow-hidden bg-[#020202]">
                <div class="canvas-container" id="container">
                    <canvas id="main-canvas"></canvas>
                </div>
                <!-- HUD Tools -->
                <div class="absolute bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 glass px-12 py-5 rounded-full border border-white/10 shadow-[0_20px_80px_rgba(0,0,0,1)] z-20">
                    <button onclick="zoomAdjust(0.7)" class="p-2 hover:text-blue-500 transition-all"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                    <button onclick="fitView()" class="text-[12px] font-black uppercase text-blue-400 border border-blue-500/30 px-6 py-2 rounded-xl hover:bg-blue-600 hover:text-white transition-all tracking-widest">Fit View</button>
                    <span id="zoom-val" class="text-[13px] font-black w-16 text-center text-slate-100">100%</span>
                    <button onclick="zoomAdjust(1.4)" class="p-2 hover:text-blue-500 transition-all"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                </div>
                <div class="absolute top-24 lg:top-8 left-8 flex gap-4 z-30">
                    <button onclick="copySets()" class="glass px-6 py-3 rounded-full text-[11px] font-black uppercase text-blue-400 hover:bg-blue-600 hover:text-white transition-all shadow-xl">Copy</button>
                    <button onclick="pasteSets()" class="glass px-6 py-3 rounded-full text-[11px] font-black uppercase text-purple-400 hover:bg-purple-600 hover:text-white transition-all shadow-xl">Paste</button>
                    <button id="comp-btn" class="glass px-8 py-3 text-[11px] font-black uppercase text-white rounded-full active:bg-blue-600 select-none transition-all shadow-xl">Compare</button>
                </div>
            </div>

            <!-- Enhanced Sidebar -->
            <div class="sidebar lg:w-[460px] glass p-8 flex flex-col gap-8 shadow-2xl overflow-y-auto custom-scrollbar flex-shrink-0 h-full">
                <div class="flex items-center justify-between border-b border-white/5 pb-6">
                    <h3 class="text-xs font-black uppercase tracking-[0.3em] text-slate-400 italic">Advanced Raw Panel</h3>
                    <button onclick="resetAll()" class="p-2 glass rounded-xl hover:bg-white/10 opacity-60 transition-all"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0-5v5h5" /></svg></button>
                </div>

                <!-- 1. STYLE STRENGTH -->
                <div class="p-8 bg-blue-600/15 rounded-[2.5rem] border border-blue-500/30 shadow-inner">
                    <div class="flex justify-between text-[12px] font-black text-blue-400 uppercase tracking-[0.15em] mb-5 italic"><span>هێزی ئیفێکت (Match Intensity)</span><span id="intensity-v">100%</span></div>
                    <input type="range" id="intensity" min="0" max="100" value="100" class="accent-blue-500">
                </div>

                <div class="space-y-3 flex-1">
                    <!-- Basic panel -->
                    <div class="accordion-item active">
                        <div class="accordion-header" onclick="toggleAcc(this)">
                            <span class="text-[12px] font-black uppercase tracking-widest text-slate-100 italic">Basic Corrections</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div class="accordion-content space-y-7 pt-6 px-1">
                            <div class="space-y-4">
                                <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Temperature</span><span id="temp-v" class="text-blue-400">0</span></div><input type="range" id="temp" min="-50" max="50" value="0" class="temp-slider"></div>
                                <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Exposure (ڕووناکی)</span><span id="exposure-v" class="text-white">100</span></div><input type="range" id="exposure" min="40" max="180" value="100"></div>
                                <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Contrast (کۆنتراست)</span><span id="contrast-v" class="text-white">100</span></div><input type="range" id="contrast" min="40" max="180" value="100"></div>
                                <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Highlights</span><span id="highlights-v" class="text-white">0</span></div><input type="range" id="highlights" min="-60" max="60" value="0"></div>
                                <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Shadows (سێبەر)</span><span id="shadows-v" class="text-white">0</span></div><input type="range" id="shadows" min="-60" max="60" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Curve panel -->
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAcc(this)">
                            <span class="text-[12px] font-black uppercase tracking-widest text-slate-100 italic">Curve Adjustments</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div class="accordion-content space-y-7 pt-6 px-1">
                            <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Lights (ڕووناکەکان)</span><span id="lights-v">0</span></div><input type="range" id="lights" min="-50" max="50" value="0"></div>
                            <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Darks (تاریکەکان)</span><span id="darks-v">0</span></div><input type="range" id="darks" min="-50" max="50" value="0"></div>
                        </div>
                    </div>

                    <!-- Face & Retouch panel -->
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAcc(this)">
                            <span class="text-[12px] font-black uppercase tracking-widest text-slate-100 italic">Face & Retouching</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div class="accordion-content space-y-7 pt-6 px-1">
                            <div class="space-y-2"><div class="flex justify-between text-[11px] font-black text-pink-400 uppercase tracking-[0.2em]"><span>Skin Smoothing</span><span id="smoothing-v">0%</span></div><input type="range" id="smoothing" min="0" max="100" value="0" class="accent-pink-500"></div>
                            <div class="space-y-2"><div class="flex justify-between text-[11px] font-black text-purple-400 uppercase tracking-[0.2em]"><span>Lipstick (ڕەنگی لێو)</span><span id="lipstick-v">0%</span></div><input type="range" id="lipstick" min="0" max="100" value="0" class="accent-purple-500"></div>
                        </div>
                    </div>

                    <!-- HSL Mixer panel -->
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAcc(this)">
                            <span class="text-[12px] font-black uppercase tracking-widest text-slate-100 italic">Color Mixer (HSL)</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div class="accordion-content space-y-7 pt-6 px-1">
                            <div class="flex flex-wrap justify-center gap-4 mb-4">
                                <button onclick="setMixColor('red','#ef4444')" class="hsl-btn bg-red-500 active"></button>
                                <button onclick="setMixColor('orange','#f97316')" class="hsl-btn bg-orange-500"></button>
                                <button onclick="setMixColor('yellow','#eab308')" class="hsl-btn bg-yellow-500"></button>
                                <button onclick="setMixColor('green','#22c55e')" class="hsl-btn bg-green-500"></button>
                                <button onclick="setMixColor('blue','#3b82f6')" class="hsl-btn bg-blue-500"></button>
                            </div>
                            <div class="space-y-2"><div class="flex justify-between text-[10px] font-bold text-slate-500 uppercase italic"><span id="mix-title">Saturation (Red)</span><span id="mix-sat-v">0</span></div><input type="range" id="mix-sat" min="-60" max="60" value="0"></div>
                        </div>
                    </div>

                    <!-- Calibration & Effects -->
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAcc(this)">
                            <span class="text-[12px] font-black uppercase tracking-widest text-slate-100 italic">Calibration & Effects</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div class="accordion-content space-y-7 pt-6 px-1">
                            <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Grain (نۆیز)</span><span id="grain-v">0</span></div><input type="range" id="grain" min="0" max="100" value="0"></div>
                            <div class="space-y-2"><div class="flex justify-between text-[10px] font-black text-slate-500 uppercase"><span>Vignette</span><span id="vignette-v">0</span></div><input type="range" id="vignette" min="-100" max="100" value="0"></div>
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="space-y-4 pt-8 border-t border-white/5 flex-shrink-0">
                    <button onclick="dlActive()" class="w-full py-7 btn-zaxm text-white rounded-[2.5rem] font-black text-lg shadow-2xl hover:scale-[1.02] active:scale-95 transition-all uppercase italic tracking-tighter">دابەزاندن بە کوالێتی (100%)</button>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="exportLUT()" class="py-4 glass text-[11px] text-blue-400 font-black uppercase rounded-[1.5rem] border border-blue-500/20">Save Pro LUT</button>
                        <button onclick="applyAll()" class="py-4 glass text-[11px] text-slate-400 font-black uppercase rounded-[1.5rem]">Sync All Batch</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let srcStats = null, batch = [], activeIdx = 0, copied = null;
        let zoomLevel = 1.0, fitScale = 1.0, isComparing = false, isRendering = false;
        let pBaseC = document.createElement('canvas');
        let selectedMixColor = 'red';

        const SLIDERS = ['temp', 'smoothing', 'intensity', 'exposure', 'contrast', 'highlights', 'shadows', 'mix-sat', 'lipstick', 'lights', 'darks', 'grain', 'vignette'];

        window.onload = () => {
            const get = (id) => document.getElementById(id);
            const els = {
                srcIn: get('src-in'), tarIn: get('tar-in'), srcHold: get('src-hold'), tarGrid: get('tar-grid'),
                procBtn: get('proc-btn'), upSec: get('upload-section'), edSec: get('editor-section'),
                canvas: get('main-canvas'), strip: get('filmstrip'), zoomVal: get('zoom-val'),
                cont: get('container'), srcDrop: get('src-drop'), tarDrop: get('tar-drop'), bCount: get('batch-count')
            };

            // --- ULTRA NEURAL TONAL ANALYSIS ---
            function getStats(ctx, w, h) {
                const d = ctx.getImageData(0,0,w,h).data;
                let r=0, g=0, b=0, c=d.length/4;
                let histogram = new Array(256).fill(0);
                for(let i=0; i<d.length; i+=4){ 
                    const l = Math.round(0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]);
                    histogram[l]++; r+=d[i]; g+=d[i+1]; b+=d[i+2];
                }
                const m = { r:r/c, g:g/c, b:b/c };
                let vr=0, vg=0, vb=0;
                for(let i=0; i<d.length; i+=4){ vr+=Math.pow(d[i]-m.r,2); vg+=Math.pow(d[i+1]-m.g,2); vb+=Math.pow(d[i+2]-m.b,2); }
                return { mean:m, std:{ r:Math.sqrt(vr/c)||1, g:Math.sqrt(vg/c)||1, b:Math.sqrt(vb/c)||1 }, histogram };
            }

            const setupDD = (drop, inp) => {
                drop.addEventListener('dragover', e => { e.preventDefault(); drop.style.borderColor = "#3b82f6"; drop.style.background = "rgba(59, 130, 246, 0.05)"; });
                drop.addEventListener('dragleave', () => { drop.style.borderColor = ""; drop.style.background = ""; });
                drop.addEventListener('drop', e => { e.preventDefault(); drop.style.borderColor = ""; drop.style.background = ""; if (e.dataTransfer.files.length) { inp.files = e.dataTransfer.files; inp.dispatchEvent(new Event('change')); } });
            };
            setupDD(els.srcDrop, els.srcIn); setupDD(els.tarDrop, els.tarIn);

            els.srcIn.onchange = e => {
                const f = e.target.files[0]; if(!f) return;
                const r = new FileReader();
                r.onload = ev => {
                    const img = new Image();
                    img.onload = () => {
                        get('src-pre').src = ev.target.result; get('src-pre').classList.remove('hidden'); els.srcHold.classList.add('hidden');
                        const t = document.createElement('canvas'); t.width=256; t.height=256; const tx = t.getContext('2d'); tx.drawImage(img,0,0,256,256);
                        srcStats = getStats(tx, 256, 256); checkReady();
                    };
                    img.src = ev.target.result;
                };
                r.readAsDataURL(f);
            };

            els.tarIn.onchange = e => {
                const fs = Array.from(e.target.files).slice(0, 30); if(!fs.length) return;
                batch = []; els.tarGrid.innerHTML = ''; els.tarGrid.classList.remove('hidden'); get('tar-hold').classList.add('hidden');
                let loaded = 0;
                fs.forEach(f => {
                    const r = new FileReader();
                    r.onload = ev => {
                        const img = new Image();
                        img.onload = () => {
                            batch.push({img, data: ev.target.result, settings: defS()});
                            const t = document.createElement('img'); t.src = ev.target.result; t.className = "w-full aspect-square object-cover rounded-2xl"; els.tarGrid.appendChild(t);
                            loaded++; if(els.bCount) els.bCount.innerText = `${loaded} Photos Ready`;
                            if(loaded === fs.length) checkReady();
                        };
                        img.src = ev.target.result;
                    };
                    r.readAsDataURL(f);
                });
            };

            const defS = () => ({ temp:0, smoothing:0, intensity:100, exposure:100, contrast:100, highlights:0, shadows:0, 'mix-sat':0, lipstick:0, lights:0, darks:0, grain:0, vignette:0 });
            const checkReady = () => { if(srcStats && batch.length) { els.procBtn.disabled=false; els.procBtn.className="px-32 py-8 btn-zaxm text-white rounded-full font-black text-3xl shadow-2xl transition-all cursor-pointer uppercase italic"; } };

            els.procBtn.onclick = () => { els.upSec.classList.add('hidden'); els.edSec.classList.remove('hidden'); loadPhoto(0); };

            const loadPhoto = idx => {
                if(batch[activeIdx]) batch[activeIdx].settings = getUI();
                activeIdx = idx; renderStrip();
                const item = batch[idx];
                
                const cw = els.cont.clientWidth - 80;
                const ch = els.cont.clientHeight - 80;
                fitScale = Math.min(cw / item.img.width, ch / item.img.height);
                zoomLevel = 1.0; 

                // --- ULTRA NEURAL MATCHING ENGINE v12 ---
                const ctx = pBaseC.getContext('2d');
                pBaseC.width = item.img.width; pBaseC.height = item.img.height;
                ctx.drawImage(item.img, 0, 0);
                const idata = ctx.getImageData(0,0,item.img.width,item.img.height);
                const d = idata.data;

                const tX = document.createElement('canvas').getContext('2d'); tX.canvas.width=256; tX.canvas.height=256;
                tX.drawImage(item.img,0,0,256,256);
                const tStats = getStats(tX, 256, 256);

                const buildCDF = h => { let cdf=new Array(256).fill(0), sum=0, tot=h.reduce((a,b)=>a+b,0); for(let i=0;i<256;i++){ sum+=h[i]; cdf[i]=sum/tot; } return cdf; };
                const sCDF = buildCDF(srcStats.histogram), tCDF = buildCDF(tStats.histogram);
                let toneLUT = new Array(256);
                for(let i=0; i<256; i++){ let j=0; while(j<255 && sCDF[j]<tCDF[i]) j++; toneLUT[i]=j; }

                const sR = srcStats.std.r / tStats.std.r; const sG = srcStats.std.g / tStats.std.g; const sB = srcStats.std.b / tStats.std.b;

                for(let j=0; j<d.length; j+=4) {
                    const lum = Math.round(0.299*d[j] + 0.587*d[j+1] + 0.114*d[j+2]);
                    const mappedLum = toneLUT[lum];
                    const ratio = mappedLum / (lum || 1);
                    
                    let nr = (d[j]-tStats.mean.r)*sR + srcStats.mean.r;
                    let ng = (d[j+1]-tStats.mean.g)*sG + srcStats.mean.g;
                    let nb = (d[j+2]-tStats.mean.b)*sB + srcStats.mean.b;
                    
                    d[j] = Math.max(0,Math.min(255, nr*0.8 + (d[j]*ratio)*0.2));
                    d[j+1] = Math.max(0,Math.min(255, ng*0.8 + (d[j+1]*ratio)*0.2));
                    d[j+2] = Math.max(0,Math.min(255, nb*0.8 + (d[j+2]*ratio)*0.2));
                }
                ctx.putImageData(idata, 0, 0);
                setUI(item.settings); updateZoom(); render();
            };

            const render = () => {
                if(isRendering) return;
                isRendering = true;
                requestAnimationFrame(() => {
                    const c = els.canvas, ctx = c.getContext('2d');
                    const item = batch[activeIdx]; if(!item) { isRendering=false; return; }
                    const w = item.img.width, h = item.img.height;
                    c.width = w; c.height = h;

                    if(isComparing) { ctx.drawImage(item.img, 0, 0); isRendering=false; return; }

                    const f = getUI();
                    const blend = f.intensity / 100;
                    const buf = document.createElement('canvas'); buf.width=w; buf.height=h; const bX = buf.getContext('2d');

                    if(blend >= 1.0) bX.drawImage(pBaseC, 0, 0);
                    else { bX.drawImage(item.img, 0, 0); bX.globalAlpha = blend; bX.drawImage(pBaseC, 0, 0); bX.globalAlpha = 1.0; }

                    // --- PIXEL PROCESSOR: CAMERA RAW FULL STACK ---
                    const idata = bX.getImageData(0,0,w,h); const d = idata.data;
                    const copy = new Uint8ClampedArray(d);
                    const step = w > 1800 ? 3 : 1; 
                    const rad = Math.max(1, Math.floor(f.smoothing/15)); 
                    const smFactor = f.smoothing/220;

                    for(let y=0; y<h; y+=step) {
                        for(let x=0; x<w; x+=step) {
                            const i = (y*w+x)*4; let r=d[i], g=d[i+1], b=d[i+2];
                            const lum = 0.299*r+0.587*g+0.114*b;

                            // Highlights, Shadows, Lights, Darks (Curve logic)
                            if(lum > 180 && f.highlights !== 0) { const m=1+(f.highlights/200); d[i]*=m; d[i+1]*=m; d[i+2]*=m; }
                            if(lum < 80 && f.shadows !== 0) { const m=1+(f.shadows/120); d[i]*=m; d[i+1]*=m; d[i+2]*=m; }
                            if(lum > 120 && f.lights !== 0) { const m=1+(f.lights/250); d[i]*=m; d[i+1]*=m; d[i+2]*=m; }
                            if(lum < 140 && f.darks !== 0) { const m=1+(f.darks/250); d[i]*=m; d[i+1]*=m; d[i+2]*=m; }

                            // HSL Mixer
                            if (f['mix-sat'] !== 0) {
                                const max=Math.max(r,g,b), min=Math.min(r,g,b), diff=max-min; let hue=0;
                                if(diff!==0){ if(max===r) hue=((g-b)/diff)%6; else if(max===g) hue=(b-r)/diff+2; else hue=(r-g)/diff+4; hue*=60; if(hue<0) hue+=360; }
                                const cMap={red:[0,30,330,360], orange:[20,50], yellow:[45,80], green:[75,160], blue:[170,260], magenta:[270,330]};
                                const rge=cMap[selectedMixColor]; let match=rge.length===2?hue>=rge[0]&&hue<=rge[1]:(hue>=rge[0]&&hue<=rge[1])||(hue>=rge[2]&&hue<=rge[3]);
                                if(match){ const sS=1+(f['mix-sat']/100); d[i]*=sS; d[i+1]*=sS; d[i+2]*=sS; }
                            }

                            // Retouch
                            if(r>70 && g>45 && r>g && (f.smoothing > 0 || f.lipstick > 0)) {
                                if(f.smoothing > 0 && y>rad && y<h-rad && x>rad && x<w-rad) {
                                    let sr=0,sg=0,sb=0,sc=0;
                                    for(let ky=-rad; ky<=rad; ky+=rad) for(let kx=-rad; kx<=rad; kx+=rad) { const ki=((y+ky)*w+(x+kx))*4; sr+=copy[ki]; sg+=copy[ki+1]; sb+=copy[ki+2]; sc++; }
                                    d[i]=copy[i]*(1-smFactor)+(sr/sc)*smFactor; d[i+1]=copy[i+1]*(1-smFactor)+(sg/sc)*smFactor; d[i+2]=copy[i+2]*(1-smFactor)+(sb/sc)*smFactor;
                                }
                                if(f.lipstick > 0 && r > g * 1.4) { d[i]=Math.min(255,d[i]+f.lipstick*0.5); d[i+1]=Math.max(0,d[i+1]-f.lipstick*0.2); }
                            }
                            
                            // Effects: Grain
                            if(f.grain > 0) { const n=(Math.random()-0.5)*f.grain; d[i]+=n; d[i+1]+=n; d[i+2]+=n; }
                        }
                    }
                    bX.putImageData(idata, 0, 0);

                    // Final Engine chain: Exposure, Contrast, Temp, Vignette
                    ctx.filter = `brightness(${f.exposure}%) contrast(${f.contrast}%)`;
                    ctx.drawImage(buf, 0, 0);

                    if(f.temp !== 0) {
                        ctx.globalCompositeOperation = 'overlay';
                        ctx.fillStyle = f.temp > 0 ? `rgba(255,180,0,${Math.abs(f.temp)/350})` : `rgba(0,100,255,${Math.abs(f.temp)/350})`;
                        ctx.fillRect(0,0,w,h);
                    }
                    if(f.vignette !== 0) {
                        const grd = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, Math.sqrt(w*w+h*h)/2);
                        grd.addColorStop(0, 'transparent'); grd.addColorStop(1, f.vignette < 0 ? `rgba(0,0,0,${Math.abs(f.vignette)/100})` : `rgba(255,255,255,${f.vignette/100})`);
                        ctx.globalCompositeOperation = 'source-over'; ctx.fillStyle = grd; ctx.fillRect(0,0,w,h);
                    }
                    isRendering = false;
                });
            };

            const renderStrip = () => { els.strip.innerHTML = ''; batch.forEach((it, i) => { const div = document.createElement('div'); div.className=`batch-item ${i===activeIdx?'active':''}`; div.innerHTML=`<img src="${it.data}" class="w-full h-full object-cover">`; div.onclick=()=>loadPhoto(i); els.strip.appendChild(div); }); };
            const getUI = () => { const o={}; SLIDERS.forEach(s => { const el=get(s); if(el) o[s]=parseInt(el.value); }); return o; };
            const setUI = o => { SLIDERS.forEach(s => { const el=get(s); if(el) { el.value=o[s]; const v=get(s+'-v'); if(v) v.innerText=(['smoothing','intensity','lipstick'].includes(s))?o[s]+'%':o[s]; } }); };

            SLIDERS.forEach(s => { const el=get(s); if(el) el.oninput=()=>{ const v=get(s+'-v'); if(v) v.innerText=(['smoothing','intensity','lipstick'].includes(s))?el.value+'%':el.value; render(); } });

            window.toggleAcc = el => { const item = el.parentElement; const active = item.classList.contains('active'); document.querySelectorAll('.accordion-item').forEach(acc => acc.classList.remove('active')); if(!active) item.classList.add('active'); };
            window.resetAll = () => { setUI(defS()); zoomLevel=1.0; updateZoom(); render(); };
            window.zoomAdjust = m => { zoomLevel *= m; if(zoomLevel<0.05) zoomLevel=0.05; updateZoom(); };
            window.fitView = () => { zoomLevel=1.0; updateZoom(); els.cont.scrollLeft=0; els.cont.scrollTop=0; };
            
            window.updateZoom = () => { 
                const it=batch[activeIdx]; if(!it) return; 
                const finalScale = fitScale * zoomLevel;
                els.canvas.style.width = (it.img.width * finalScale) + 'px';
                els.canvas.style.height = (it.img.height * finalScale) + 'px';
                els.zoomVal.innerText = Math.round(zoomLevel * 100) + '%'; 
            };

            window.copySets = () => { copied=getUI(); els.toast.classList.remove('hidden'); setTimeout(()=>els.toast.classList.add('hidden'),1500); };
            window.pasteSets = () => { if(copied) { setUI(copied); render(); } };
            window.applyAll = () => { const s=getUI(); batch.forEach(it=>it.settings={...s}); alert('Settings Synced! ✓'); };
            window.setMixColor = (c, hex) => { selectedMixColor = c; get('mix-title').innerText = `Saturation (${c})`; get('mix-title').style.color = hex; document.querySelectorAll('.hsl-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); render(); };
            
            window.dlActive = () => { 
                const link = document.createElement('a');
                link.download = `Tahir_v12_${activeIdx+1}.jpg`;
                link.href = els.canvas.toDataURL('image/jpeg', 1.0); 
                link.click();
            };

            window.exportLUT = () => {
                if (!srcStats || !pBaseC) return;
                const size = 33; let cube = `TITLE "TAHIR_LUT"\nLUT_3D_SIZE ${size}\n\n`;
                const dr=(srcStats.mean.r-128)/255; const dg=(srcStats.mean.g-128)/255; const db=(srcStats.mean.b-128)/255;
                for(let b=0; b<size; b++) for(let g=0; g<size; g++) for(let r=0; r<size; r++) cube+=`${Math.max(0, Math.min(1, r/(size-1)+dr)).toFixed(6)} ${Math.max(0, Math.min(1, g/(size-1)+dg)).toFixed(6)} ${Math.max(0, Math.min(1, b/(size-1)+db)).toFixed(6)}\n`;
                const blob = new Blob([cube], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "Tahir_Style.cube"; a.click();
            };

            let isD=false, sx, sy, sl, st;
            els.cont.onmousedown = e => { if(zoomLevel<=1) return; isD=true; sx=e.pageX-els.cont.offsetLeft; sy=e.pageY-els.cont.offsetTop; sl=els.cont.scrollLeft; st=els.cont.scrollTop; };
            window.addEventListener('mouseup',()=>isD=false);
            els.cont.onmousemove = e => { if(!isD) return; els.cont.scrollLeft=sl-(e.pageX-els.cont.offsetLeft-sx); els.cont.scrollTop=st-(e.pageY-els.cont.offsetTop-sy); };

            get('comp-btn').onmousedown = () => { isComparing=true; render(); };
            get('comp-btn').onmouseup = () => { isComparing=false; render(); };
            get('comp-btn').ontouchstart = () => { isComparing=true; render(); };
            get('comp-btn').ontouchend = () => { isComparing=false; render(); };
        };
    </script>
</body>
</html>
